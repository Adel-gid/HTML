<!-- Code is licensed under BSD 2.0. Audio assets (not included) are property of their respective owners. -->

<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<title>Ao Oni Password Trainer</title>
	<style>
		@font-face {
			font-family: 'Retro';
			src: local('Courier New'), monospace;
		}

		body {
			background-color: #fdf5e6;
			margin: 0;
			padding: 0;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			height: 100vh;
			font-family: 'Retro', monospace;
			user-select: none;
			overflow: hidden;
		}

		.top-left-controls {
			position: absolute;
			top: 20px;
			left: 20px;
			z-index: 50;
		}

		.app-wrapper {
			display: flex;
			flex-direction: row;
			align-items: center;
			justify-content: center;
			gap: 40px;
			width: 100%;
		}

		.lock-container {
			background-color: black;
			border: 2px solid white;
			border-radius: 3px;
			padding: 25px 40px;
			box-shadow: 0 0 0 4px black;
			position: relative;
		}

		.game-panel {
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		#lock-box {
			width: 400px;
			height: 80px;
			display: flex;
			align-items: center;
			justify-content: flex-start;
			transition: width 0.3s ease;
		}

		.digits-display {
			display: flex;
			align-items: center;
			gap: 4px;
			margin-left: 10px;
		}

		.digit-block {
			display: flex;
			align-items: center;
		}

		.cursor {
			color: white;
			font-size: 20px;
			width: 14px;
			text-align: right;
			margin-right: 2px;
		}

		.cursor.hidden-cursor { visibility: hidden; }

		.digit {
			color: white;
			font-size: 28px;
			width: 20px;
			text-align: center;
			font-family: 'Retro', monospace;
		}

		.z-prompt {
			position: absolute;
			top: 0; left: 0; right: 0; bottom: 0;
			background-color: black;
			color: white;
			font-size: 64px;
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 10;
			border-radius: 3px;
		}

		#config-panel {
			width: 450px;
			max-height: 80vh;
			display: flex;
			flex-direction: column;
			color: white;
			font-size: 16px;
		}

		.config-header {
			text-align: center;
			font-size: 24px;
			margin-bottom: 15px;
			letter-spacing: 2px;
		}

		.config-sections-container {
			flex-grow: 1;
			overflow-y: auto;
			margin-bottom: 20px;
			padding-right: 10px;
		}

		.config-sections-container::-webkit-scrollbar { width: 8px; }
		.config-sections-container::-webkit-scrollbar-track { background: #111; }
		.config-sections-container::-webkit-scrollbar-thumb { background: #fff; border-radius: 4px; }

		.config-section {
			margin-bottom: 15px;
			border-bottom: 1px dashed #444;
			padding-bottom: 10px;
		}

		.sec-header {
			display: flex;
			justify-content: space-between;
			color: #ccc;
			margin-bottom: 8px;
			font-weight: bold;
		}

		.collapse-icon {
			cursor: pointer;
			color: white;
			margin-right: 5px;
		}
		.collapse-icon:hover { color: #aaa; }

		.code-row {
			display: flex;
			justify-content: space-between;
			padding-left: 20px;
			margin-bottom: 4px;
		}

		.icon-btn {
			cursor: pointer;
			margin-left: 8px;
			user-select: none;
			font-size: 18px;
		}

		.icon-btn:hover { opacity: 0.7; }
		.icon-btn.blue { color: #4da6ff; }
		.icon-btn.red { color: #ff4d4d; }
		.icon-btn.yellow { color: #ffcc00; }
		.icon-btn.gray { color: #555; filter: grayscale(100%); }

		.config-footer {
			text-align: center;
			border-top: 2px solid white;
			padding-top: 15px;
		}

		.btn-row { margin-bottom: 10px; display: flex; justify-content: center; gap: 15px; }

		.retro-btn {
			font-family: 'Retro', monospace;
			padding: 8px 15px;
			cursor: pointer;
			border: 2px solid white;
			background: black;
			color: white;
			font-size: 16px;
			font-weight: bold;
			transition: all 0.1s ease;
		}
		.retro-btn:hover { opacity: 0.8; }
		.retro-btn:active { background: #333; }

		.mode-all { color: #4CAF50; border-color: #4CAF50; }
		.mode-all.selected { background: #4CAF50; color: black; }
		.mode-random { color: #FF9800; border-color: #FF9800; }
		.mode-random.selected { background: #FF9800; color: black; }

		.btn-mute { color: #ccc; border-color: #ccc; }
		.btn-mute.muted { background: #ccc; color: black; }

		.start-btn { color: #fff; border-color: #fff; background: #222; }
		
		.red-btn { color: #ff4d4d; border-color: #ff4d4d; }
		.red-btn:active { background: #ff4d4d; color: black; }

		.hidden { display: none !important; }

		.ui-panel {
			margin-bottom: 20px;
			text-align: center;
			height: 100px;
			font-size: 20px;
			font-weight: bold;
			color: #333;
			width: 400px;
		}

		.hint-text {
			color: #d32f2f;
			margin-top: 10px;
			font-size: 22px;
			min-height: 30px;
		}

		.restart-btn {
			position: absolute;
			bottom: 20px;
			right: 20px;
			padding: 10px 20px;
			background-color: #333;
			color: white;
			border: 2px solid #111;
			cursor: pointer;
			font-family: 'Retro', monospace;
			font-size: 16px;
		}
		.restart-btn:hover { background-color: #555; }
		.restart-btn:active { background-color: #000; }

		#lang-modal {
			position: fixed; top: 0; left: 0; right: 0; bottom: 0;
			background-color: rgba(0, 0, 0, 0.95);
			display: flex; flex-direction: column; align-items: center; justify-content: center;
			z-index: 1000;
		}

		.lang-flag { width: 80px; height: 50px; border: 2px solid white; object-fit: cover; }
		.lang-flag-small { width: 40px; height: 25px; border: 2px solid white; object-fit: cover; cursor: pointer; }

		.flag-fallback, .flag-fallback-small {
			display: inline-block;
			background: black; color: black;
			-webkit-text-stroke: 1px white;
			font-family: 'Retro', monospace;
			border: 2px solid white; text-align: center; box-sizing: border-box;
		}
		.flag-fallback {
			width: 80px; height: 50px; line-height: 46px;
			font-size: 32px; font-weight: bold;
		}
		.flag-fallback-small {
			width: 40px; height: 25px; line-height: 21px;
			font-size: 16px; font-weight: bold; cursor: pointer;
		}
	</style>
</head>
<body>
	<div class="top-left-controls" id="top-left-controls">
		<div id="btn-lang-top" onclick="showLangModal()" title="Change Language"></div>
	</div>

	<div id="lang-modal" class="hidden">
		<h2 style="font-family: 'Retro', monospace; text-align: center; margin-bottom: 40px; color: white;">Please select a language</h2>
		<div style="display: flex; gap: 40px;">
			<div onclick="selectLang('en')" style="cursor: pointer; text-align: center;">
				<img src="https://upload.wikimedia.org/wikipedia/en/a/ae/Flag_of_the_United_Kingdom.svg" class="lang-flag" onerror="this.outerHTML='<span class=\\'flag-fallback\\'>EN</span>'">
				<div style="margin-top: 10px; font-size: 20px; color: white; font-family: 'Retro', monospace;">English</div>
			</div>
			<div onclick="selectLang('jp')" style="cursor: pointer; text-align: center;">
				<img src="https://upload.wikimedia.org/wikipedia/en/9/9e/Flag_of_Japan.svg" class="lang-flag" onerror="this.outerHTML='<span class=\\'flag-fallback\\'>JP</span>'">
				<div style="margin-top: 10px; font-size: 20px; color: white; font-family: 'Retro', monospace;">æ—¥æœ¬èªž</div>
			</div>
			<div onclick="selectLang('zh')" style="cursor: pointer; text-align: center;">
				<img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Flag_of_the_People%27s_Republic_of_China.svg" class="lang-flag" onerror="this.outerHTML='<span class=\\'flag-fallback\\'>ZH</span>'">
				<div style="margin-top: 10px; font-size: 20px; color: white; font-family: 'Retro', monospace;">ä¸­æ–‡</div>
			</div>
			<div onclick="selectLang('ko')" style="cursor: pointer; text-align: center;">
				<img src="https://upload.wikimedia.org/wikipedia/commons/0/09/Flag_of_South_Korea.svg" class="lang-flag" onerror="this.outerHTML='<span class=\\'flag-fallback\\'>KO</span>'">
				<div style="margin-top: 10px; font-size: 20px; color: white; font-family: 'Retro', monospace;">í•œêµ­ì–´</div>
			</div>
		</div>
	</div>

	<div class="app-wrapper">
		<div id="config-panel" class="lock-container hidden">
			<div class="config-header" id="config-header-text">SYSTEM SETUP</div>
			<div id="config-sections-container" class="config-sections-container"></div>

			<div class="config-footer">
				<div class="btn-row">
					<button id="btn-mode-all" class="retro-btn mode-all selected" onclick="setMode('ALL')">All</button>
					<button id="btn-mode-random" class="retro-btn mode-random" onclick="setMode('RANDOM')">Random</button>
					<button id="btn-mute" class="retro-btn btn-mute" onclick="toggleMute()">Mute</button>
				</div>
				<div class="btn-row">
					<button id="btn-add-sec" class="retro-btn" onclick="askCreateSection()">+ Section</button>
					<button id="btn-start" class="retro-btn start-btn" onclick="startTraining()">START TRAINING</button>
				</div>
				<div class="btn-row" style="margin-top: 15px;">
					<button id="btn-hard-reset" class="retro-btn red-btn" onclick="onHardResetClick()">Hard Reset</button>
				</div>
			</div>
		</div>

		<div id="game-panel" class="game-panel hidden">
			<div class="ui-panel">
				<div id="category-name">Waiting...</div>
				<div id="message-area"></div>
				<div id="hint-area" class="hint-text hidden"></div>
			</div>

			<div class="lock-container" id="lock-box">
				<div class="z-prompt" id="z-prompt">Z</div>
				<div class="digits-display" id="digits-display"></div>
			</div>
		</div>
	</div>

	<button class="restart-btn" id="restart-btn">Full restart</button>

	<script>
		const I18N = {
			en: {
				setup: "SYSTEM SETUP", modeAll: "All", modeRand: "Random", mute: "Mute", unmute: "Unmute",
				addSec: "+ Section", start: "START TRAINING", restart: "Full restart", hardReset: "Hard Reset",
				cat: "Category", total: "Total time", ms: "ms", waiting: "Waiting...",
				wrong: "Wrong!", next: "Okay. Next.", good: "Good!", goodBut: "Good, but not this one.",
				promptNewSec: "Enter a new section name:", promptLen: "Code length (e.g. 4):",
				errLen: "Invalid length.", errTooLong: "Error! The code is so long that it will extend beyond the screen.",
				promptCodeFirst: "Enter the FIRST code (strictly {0} digits):",
				promptCodeNew: "Enter the new code (strictly {0} digits):",
				promptCodeEdit: "Enter the code (strictly {0} digits):",
				errDigits: "Error! Only numbers.", errDigitsLen: "Error! Need exactly {0} digits.",
				errActive: "Error! The section must contain at least one enabled code.",
				errLastCode: "Error! You cannot delete the last code in a section.",
				confirmDelSec: "Delete section '{0}'?", confirmDelCode: "Remove this code?",
				errNeedSec: "Error! There must be at least one section.",
				allComplete: "All Complete!", completeMsg: "Total time: {0} ms. Press Full Restart.",
				promptRename: "Enter a new section name:"
			},
			jp: {
				setup: "ã‚·ã‚¹ãƒ†ãƒ è¨­å®š", modeAll: "ã™ã¹ã¦", modeRand: "ãƒ©ãƒ³ãƒ€ãƒ ", mute: "æ¶ˆéŸ³", unmute: "æ¶ˆéŸ³è§£é™¤",
				addSec: "+ ã‚»ã‚¯ã‚·ãƒ§ãƒ³", start: "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹", restart: "å†èµ·å‹•", hardReset: "å®Œå…¨åˆæœŸåŒ–",
				cat: "ã‚«ãƒ†ã‚´ãƒª", total: "åˆè¨ˆæ™‚é–“", ms: "ãƒŸãƒªç§’", waiting: "å¾…æ©Ÿä¸­...",
				wrong: "é–“é•ã„ï¼", next: "æ­£è§£ã€‚æ¬¡ã¸ã€‚", good: "åˆæ ¼ï¼", goodBut: "æ­£è§£ã§ã™ãŒã€ã“ã‚Œã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",
				promptNewSec: "æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³åã‚’å…¥åŠ›:", promptLen: "ã‚³ãƒ¼ãƒ‰ã®é•·ã•ï¼ˆä¾‹: 4ï¼‰:",
				errLen: "ç„¡åŠ¹ãªé•·ã•ã§ã™ã€‚", errTooLong: "ã‚¨ãƒ©ãƒ¼ï¼ã‚³ãƒ¼ãƒ‰ãŒé•·ã™ãŽã¦ç”»é¢ã«åŽã¾ã‚Šã¾ã›ã‚“ã€‚",
				promptCodeFirst: "æœ€åˆã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆåŽ³å¯†ã« {0} æ¡ï¼‰:",
				promptCodeNew: "æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆåŽ³å¯†ã« {0} æ¡ï¼‰:",
				promptCodeEdit: "ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆåŽ³å¯†ã« {0} æ¡ï¼‰:",
				errDigits: "ã‚¨ãƒ©ãƒ¼ï¼æ•°å­—ã®ã¿å…¥åŠ›å¯èƒ½ã§ã™ã€‚", errDigitsLen: "ã‚¨ãƒ©ãƒ¼ï¼åŽ³å¯†ã« {0} æ¡å¿…è¦ã§ã™ã€‚",
				errActive: "ã‚¨ãƒ©ãƒ¼ï¼æœ‰åŠ¹ãªã‚³ãƒ¼ãƒ‰ãŒå°‘ãªãã¨ã‚‚1ã¤å¿…è¦ã§ã™ã€‚",
				errLastCode: "ã‚¨ãƒ©ãƒ¼ï¼æœ€å¾Œã®ã‚³ãƒ¼ãƒ‰ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚",
				confirmDelSec: "ã‚»ã‚¯ã‚·ãƒ§ãƒ³ '{0}' ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", confirmDelCode: "ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
				errNeedSec: "ã‚¨ãƒ©ãƒ¼ï¼å°‘ãªãã¨ã‚‚1ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã§ã™ã€‚",
				allComplete: "ã™ã¹ã¦å®Œäº†ï¼", completeMsg: "åˆè¨ˆæ™‚é–“: {0} ãƒŸãƒªç§’ã€‚å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚",
				promptRename: "æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³åã‚’å…¥åŠ›:"
			},
			zh: {
				setup: "ç³»ç»Ÿè®¾ç½®", modeAll: "å…¨éƒ¨", modeRand: "éšæœº", mute: "é™éŸ³", unmute: "å–æ¶ˆé™éŸ³",
				addSec: "+ æ·»åŠ éƒ¨åˆ†", start: "å¼€å§‹è®­ç»ƒ", restart: "å®Œå…¨é‡å¯", hardReset: "ç¡¬é‡ç½®",
				cat: "ç±»åˆ«", total: "æ€»æ—¶é—´", ms: "æ¯«ç§’", waiting: "ç­‰å¾…ä¸­...",
				wrong: "é”™è¯¯ï¼", next: "æ­£ç¡®ã€‚ä¸‹ä¸€ä¸ªã€‚", good: "å¤ªæ£’äº†ï¼", goodBut: "æ­£ç¡®ï¼Œä½†ä¸æ˜¯è¿™ä¸ªã€‚",
				promptNewSec: "è¾“å…¥æ–°çš„éƒ¨åˆ†åç§°:", promptLen: "ä»£ç é•¿åº¦ï¼ˆä¾‹å¦‚ï¼š4ï¼‰:",
				errLen: "é•¿åº¦æ— æ•ˆã€‚", errTooLong: "é”™è¯¯ï¼ä»£ç å¤ªé•¿ï¼Œä¼šè¶…å‡ºå±å¹•èŒƒå›´ã€‚",
				promptCodeFirst: "è¾“å…¥ç¬¬ä¸€ä¸ªä»£ç ï¼ˆä¸¥æ ¼ {0} ä½æ•°å­—ï¼‰:",
				promptCodeNew: "è¾“å…¥æ–°ä»£ç ï¼ˆä¸¥æ ¼ {0} ä½æ•°å­—ï¼‰:",
				promptCodeEdit: "è¾“å…¥ä»£ç ï¼ˆä¸¥æ ¼ {0} ä½æ•°å­—ï¼‰:",
				errDigits: "é”™è¯¯ï¼åªèƒ½è¾“å…¥æ•°å­—ã€‚", errDigitsLen: "é”™è¯¯ï¼éœ€è¦ç²¾ç¡® {0} ä½æ•°å­—ã€‚",
				errActive: "é”™è¯¯ï¼è¯¥éƒ¨åˆ†å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ªå·²å¯ç”¨çš„ä»£ç ã€‚",
				errLastCode: "é”™è¯¯ï¼æ‚¨ä¸èƒ½åˆ é™¤éƒ¨åˆ†ä¸­çš„æœ€åŽä¸€ä¸ªä»£ç ã€‚",
				confirmDelSec: "åˆ é™¤éƒ¨åˆ† '{0}' å—ï¼Ÿ", confirmDelCode: "åˆ é™¤æ­¤ä»£ç å—ï¼Ÿ",
				errNeedSec: "é”™è¯¯ï¼å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªéƒ¨åˆ†ã€‚",
				allComplete: "å…¨éƒ¨å®Œæˆï¼", completeMsg: "æ€»æ—¶é—´: {0} æ¯«ç§’ã€‚è¯·æŒ‰å®Œå…¨é‡å¯ã€‚",
				promptRename: "è¾“å…¥æ–°çš„éƒ¨åˆ†åç§°:"
			},
			ko: {
				setup: "ì‹œìŠ¤í…œ ì„¤ì •", modeAll: "ëª¨ë‘", modeRand: "ëžœë¤", mute: "ìŒì†Œê±°", unmute: "ìŒì†Œê±° í•´ì œ",
				addSec: "+ ì„¹ì…˜ ì¶”ê°€", start: "í›ˆë ¨ ì‹œìž‘", restart: "ì „ì²´ ìž¬ì‹œìž‘", hardReset: "ì´ˆê¸°í™”",
				cat: "ì¹´í…Œê³ ë¦¬", total: "ì´ ì‹œê°„", ms: "ë°€ë¦¬ì´ˆ", waiting: "ëŒ€ê¸° ì¤‘...",
				wrong: "ì˜¤ë‹µ!", next: "ì •ë‹µ. ë‹¤ìŒ.", good: "ì¢‹ìŠµë‹ˆë‹¤!", goodBut: "ì •ë‹µì´ì§€ë§Œ, ì´ê±´ ì•„ë‹™ë‹ˆë‹¤.",
				promptNewSec: "ìƒˆ ì„¹ì…˜ ì´ë¦„ì„ ìž…ë ¥í•˜ì„¸ìš”:", promptLen: "ì½”ë“œ ê¸¸ì´ (ì˜ˆ: 4):",
				errLen: "ìž˜ëª»ëœ ê¸¸ì´ìž…ë‹ˆë‹¤.", errTooLong: "ì˜¤ë¥˜! ì½”ë“œê°€ ë„ˆë¬´ ê¸¸ì–´ í™”ë©´ì„ ë²—ì–´ë‚©ë‹ˆë‹¤.",
				promptCodeFirst: "ì²« ë²ˆì§¸ ì½”ë“œë¥¼ ìž…ë ¥í•˜ì„¸ìš” (ì •í™•ížˆ {0}ìžë¦¬):",
				promptCodeNew: "ìƒˆ ì½”ë“œë¥¼ ìž…ë ¥í•˜ì„¸ìš” (ì •í™•ížˆ {0}ìžë¦¬):",
				promptCodeEdit: "ì½”ë“œë¥¼ ìž…ë ¥í•˜ì„¸ìš” (ì •í™•ížˆ {0}ìžë¦¬):",
				errDigits: "ì˜¤ë¥˜! ìˆ«ìžë§Œ ìž…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.", errDigitsLen: "ì˜¤ë¥˜! ì •í™•ížˆ {0}ìžë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.",
				errActive: "ì˜¤ë¥˜! í™œì„±í™”ëœ ì½”ë“œê°€ í•˜ë‚˜ ì´ìƒ ìžˆì–´ì•¼ í•©ë‹ˆë‹¤.",
				errLastCode: "ì˜¤ë¥˜! ë§ˆì§€ë§‰ ì½”ë“œëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
				confirmDelSec: "'{0}' ì„¹ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", confirmDelCode: "ì´ ì½”ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
				errNeedSec: "ì˜¤ë¥˜! ì„¹ì…˜ì´ ìµœì†Œ í•˜ë‚˜ëŠ” ìžˆì–´ì•¼ í•©ë‹ˆë‹¤.",
				allComplete: "ëª¨ë‘ ì™„ë£Œ!", completeMsg: "ì´ ì‹œê°„: {0} ë°€ë¦¬ì´ˆ. ì „ì²´ ìž¬ì‹œìž‘ì„ ëˆ„ë¥´ì„¸ìš”.",
				promptRename: "ìƒˆ ì„¹ì…˜ ì´ë¦„ì„ ìž…ë ¥í•˜ì„¸ìš”:"
			}
		};

		let curLang = 'en'; 
		const t = (key, ...args) => {
			let str = (I18N[curLang] && I18N[curLang][key]) || (I18N['en'][key]) || key;
			args.forEach((arg, i) => { str = str.replace(`{${i}}`, arg); });
			return str;
		};
		
		const $ = id => document.getElementById(id);
		
		const sndMove = new Audio('Audio/001-System01.ogg');
		const sndConfirm = new Audio('Audio/002-System02.ogg');
		const sndRestart = new Audio('Audio/003-System03.ogg');
		const sndUnavailable = new Audio('Audio/004-System04.ogg');

		let isMuted = false;

		function playSound(audioObj) {
			if (isMuted || !audioObj) return;
			audioObj.currentTime = 0;
			audioObj.play().catch(() => {});
		}

		function showError(msg) {
			playSound(sndUnavailable);
			setTimeout(() => alert(msg), 15);
		}

		// ==========================================
		//		 DATA & STORAGE LOGIC
		// ==========================================

		const defaultCategories =[
			{
				name: "Piano", isCollapsed: false,
				codes:[ { target: "6799", isActive: true }, { target: "9761", isActive: true }, { target: "6392", isActive: true }, { target: "1416", isActive: true }, { target: "5156", isActive: true } ]
			},
			{
				name: "Closet", isCollapsed: false,
				codes:[ { target: "5376", isActive: true } ]
			},
			{
				name: "Safe", isCollapsed: false,
				codes:[ { target: "290", isActive: true }, { target: "361", isActive: true }, { target: "528", isActive: true } ]
			},
			{
				name: "Iron door", isCollapsed: false,
				codes:[ { target: "1237", isActive: true } ]
			},
			{
				name: "Another safe", isCollapsed: false,
				codes:[ { target: "3045", isActive: true } ]
			}
		];

		let categories =[];

		function populateHints(cats) {
			cats.forEach(cat => {
				cat.codes.forEach(c => { c.hint = findSolution(c.target); });
			});
		}

		function saveData() {
			try {
				localStorage.setItem('aoOniLang', curLang);
				localStorage.setItem('aoOniCategories', JSON.stringify(categories));
			} catch(e) { console.error("Save error", e); }
		}

		function loadData() {
			try {
				const savedLang = localStorage.getItem('aoOniLang');
				const savedCats = localStorage.getItem('aoOniCategories');
				if (savedLang) curLang = savedLang;
				if (savedCats) {
					categories = JSON.parse(savedCats);
				} else {
					categories = JSON.parse(JSON.stringify(defaultCategories));
				}
				populateHints(categories);
			} catch(e) {
				categories = JSON.parse(JSON.stringify(defaultCategories));
				populateHints(categories);
			}
		}

		let isInitMode = false;

		function initApp() {
			populateHints(defaultCategories);
			const savedLang = localStorage.getItem('aoOniLang');
			if (!savedLang) {
				categories = JSON.parse(JSON.stringify(defaultCategories));
				populateHints(categories);
				isInitMode = true;
				showLangModal();
			} else {
				loadData();
				updateUILocale();
				updateTopLeftFlag();
				initConfig();
			}
		}

		function showLangModal() {
			$('lang-modal').classList.remove('hidden');
		}

		window.selectLang = function(langCode) {
			playSound(sndConfirm);
			curLang = langCode;
			saveData();
			updateUILocale();
			updateTopLeftFlag();
			$('lang-modal').classList.add('hidden');

			if (isInitMode) {
				isInitMode = false;
				initConfig();
			} else {
				if (state === 'CONFIG') renderConfig();
			}
		};

		function updateTopLeftFlag() {
			const flagMap = {
				en: "https://upload.wikimedia.org/wikipedia/en/a/ae/Flag_of_the_United_Kingdom.svg",
				jp: "https://upload.wikimedia.org/wikipedia/en/9/9e/Flag_of_Japan.svg",
				zh: "https://upload.wikimedia.org/wikipedia/commons/f/fa/Flag_of_the_People%27s_Republic_of_China.svg",
				ko: "https://upload.wikimedia.org/wikipedia/commons/0/09/Flag_of_South_Korea.svg"
			};
			const fName = curLang.toUpperCase();
			$('btn-lang-top').innerHTML = `<img src="${flagMap[curLang]}" class="lang-flag-small" onerror="this.outerHTML='<span class=\\'flag-fallback-small\\'>${fName}</span>'">`;
		}

		function updateUILocale() {
			$('config-header-text').innerText = t('setup');
			$('btn-mode-all').innerText = t('modeAll');
			$('btn-mode-random').innerText = t('modeRand');
			$('btn-mute').innerText = isMuted ? t('unmute') : t('mute');
			$('btn-add-sec').innerText = t('addSec');
			$('btn-start').innerText = t('start');
			$('restart-btn').innerText = t('restart');
			$('btn-hard-reset').innerText = t('hardReset');

			if (state === 'FINISHED') {
				elCategory.innerText = t('allComplete');
			} else if (state === 'WAITING_Z') {
				if (categories[currentCategoryIdx]) {
					elCategory.innerText = `${t('cat')}: ${categories[currentCategoryIdx].name}`;
				}
			}
		}

		let hrClicks = 0;
		let hrTimeout = null;

		window.onHardResetClick = function() {
			hrClicks++;
			playSound(sndMove);
			if(hrTimeout) clearTimeout(hrTimeout);

			const btn = $('btn-hard-reset');
			
			if(hrClicks >= 5) {
				hrClicks = 0;
				btn.innerText = t('hardReset');
				playSound(sndRestart);
				performHardReset();
			} else {
				btn.innerText = `[ ${5 - hrClicks} ]`;
				hrTimeout = setTimeout(() => { 
					hrClicks = 0; 
					btn.innerText = t('hardReset');
				}, 800);
			}
		};

		function performHardReset() {
			localStorage.removeItem('aoOniLang');
			localStorage.removeItem('aoOniCategories');
			categories = JSON.parse(JSON.stringify(defaultCategories));
			populateHints(categories);
			isInitMode = true;
			
			elConfigPanel.classList.add('hidden');
			elGamePanel.classList.add('hidden');
			showLangModal();
		}

		// ==========================================
		//		 ALGORITHM
		// ==========================================

		function findSolution(number) {
			if (!number) return "Z";
			const arrowNotation = { "0": "", "1": "â†‘", "2": "â†‘â†‘", "3": "â†‘â†‘â†‘", "4": "â†‘â†‘â†‘â†‘", "5": "â†‘â†‘â†‘â†‘â†‘", "6": "â†“â†“â†“â†“", "7": "â†“â†“â†“", "8": "â†“â†“", "9": "â†“" };
			const n = number.length;
			const targets =[];
			for (let i = 0; i < n; i++) { if (number[i] !== '0') targets.push(i); }
			if (targets.length === 0) return "Z";

			let targetMask = 0;
			for (const t of targets) targetMask |= (1 << t);

			const startPos = 0;
			const startMask = (number[0] !== '0') ? (1 << 0) : 0;
			const startPath = arrowNotation[number[0]];

			let queue = [[startPos, startMask, startPath]];
			const visited = new Set();
			visited.add(`${startPos}_${startMask}`);

			let head = 0;
			while (head < queue.length) {
				const [pos, mask, path] = queue[head++];
				if (mask === targetMask) return path + " Z";
				
				const moves =[ { char: "â†’", step: 1 }, { char: "â†", step: -1 } ];
				for (const move of moves) {
					let newPos = (pos + move.step + n) % n;
					let addedArrows = "";
					let newMask = mask;

					if (number[newPos] !== '0' && !(mask & (1 << newPos))) {
						addedArrows = arrowNotation[number[newPos]];
						newMask |= (1 << newPos);
					}
					const newPath = path + move.char + addedArrows;
					const stateKey = `${newPos}_${newMask}`;
					if (!visited.has(stateKey)) {
						visited.add(stateKey);
						queue.push([newPos, newMask, newPath]);
					}
				}
			}
			return "Z";
		}

		let gameMode = 'ALL';
		let currentCategoryIdx = 0;
		let enteredCodes = [];
		let digits =[];
		let cursorPos = 0;

		let state = 'CONFIG';
		let blindMode = false;
		let showHint = false;
		let qHeld = false;

		let startTime = 0;
		let totalStartTime = 0;

		const elConfigPanel = $('config-panel');
		const elGamePanel = $('game-panel');
		const elConfigContainer = $('config-sections-container');

		const elCategory = $('category-name');
		const elMessage = $('message-area');
		const elHint = $('hint-area');
		const elDigits = $('digits-display');
		const elZPrompt = $('z-prompt');
		const elLockBox = $('lock-box');
		const btnRestart = $('restart-btn');

		// ==========================================
		//		 CONFIGURATION LOGIC
		// ==========================================

		function toggleMute() {
			isMuted = !isMuted;
			const btn = $('btn-mute');
			btn.innerText = isMuted ? t('unmute') : t('mute');
			btn.classList.toggle('muted', isMuted);
			if (!isMuted) playSound(sndMove);
		}

		function setMode(mode) {
			playSound(sndMove);
			gameMode = mode;
			$('btn-mode-all').classList.toggle('selected', mode === 'ALL');
			$('btn-mode-random').classList.toggle('selected', mode === 'RANDOM');
		}

		window.toggleCollapse = function(cIdx) {
			playSound(sndMove);
			categories[cIdx].isCollapsed = !categories[cIdx].isCollapsed;
			saveData();
			renderConfig();
		};

		function renderConfig() {
			elConfigContainer.innerHTML = '';
			categories.forEach((cat, cIdx) => {
				let collapseIcon = cat.isCollapsed ? '[*]' : '[+]';
				let secHtml = `
					<div class="config-section">
						<div class="sec-header">
							<div>
								<span class="collapse-icon" onclick="toggleCollapse(${cIdx})" title="Collapse/Expand">${collapseIcon}</span>
								<span>${cat.name}</span>
							</div>
							<div>
								<span class="icon-btn blue" onclick="askEditSection(${cIdx})" title="Rename section">âœŽ</span>
								<span class="icon-btn blue" onclick="askAddCode(${cIdx})" title="Add code to section">âž•</span>
								<span class="icon-btn red" onclick="askDeleteSection(${cIdx})" title="Delete section">âœ–</span>
							</div>
						</div>
				`;

				if (!cat.isCollapsed) {
					cat.codes.forEach((codeObj, codeIdx) => {
						let bulbClass = codeObj.isActive ? 'yellow' : 'gray';
						let hintStr = codeObj.hint ? ` <span style="color:#888;font-size:12px;">(${codeObj.hint})</span>` : '';
						secHtml += `
							<div class="code-row">
								<span>â””â”€ ${codeObj.target}${hintStr}</span>
								<div>
									<span class="icon-btn blue" onclick="askEditCode(${cIdx}, ${codeIdx})" title="Change code">âœŽ</span>
									<span class="icon-btn ${bulbClass}" onclick="toggleCodeActive(${cIdx}, ${codeIdx})" title="On/Off">ðŸ’¡</span>
									<span class="icon-btn red" onclick="askDeleteCode(${cIdx}, ${codeIdx})" title="Remove code">âœ–</span>
								</div>
							</div>
						`;
					});
				}
				secHtml += `</div>`;
				elConfigContainer.innerHTML += secHtml;
			});
		}

		window.askEditSection = function(cIdx) {
			playSound(sndMove);
			let newVal = prompt(t('promptRename'), categories[cIdx].name);
			if(newVal !== null && newVal.trim() !== "") {
				categories[cIdx].name = newVal.trim();
				saveData();
				renderConfig();
			}
		};

		window.askDeleteSection = function(cIdx) {
			playSound(sndMove);
			if(categories.length <= 1) return showError(t('errNeedSec'));
			if(confirm(t('confirmDelSec', categories[cIdx].name))) {
				categories.splice(cIdx, 1);
				saveData();
				renderConfig();
			}
		};

		window.askEditCode = function(cIdx, codeIdx) {
			playSound(sndMove);
			let codeObj = categories[cIdx].codes[codeIdx];
			let reqLen = categories[cIdx].codes[0].target.length;
			let newCode = prompt(t('promptCodeEdit', reqLen), codeObj.target);
			if(newCode !== null) {
				newCode = newCode.trim();
				if(newCode.length !== reqLen) return showError(t('errDigitsLen', reqLen));
				if(!/^\d+$/.test(newCode)) return showError(t('errDigits'));

				codeObj.target = newCode;
				codeObj.hint = findSolution(newCode);
				saveData();
				renderConfig();
			}
		};

		window.toggleCodeActive = function(cIdx, codeIdx) {
			playSound(sndMove);
			let codeObj = categories[cIdx].codes[codeIdx];
			if(codeObj.isActive) {
				let activeCount = categories[cIdx].codes.filter(c => c.isActive).length;
				if(activeCount <= 1) return showError(t('errActive'));
			}
			codeObj.isActive = !codeObj.isActive;
			saveData();
			renderConfig();
		};

		window.askDeleteCode = function(cIdx, codeIdx) {
			playSound(sndMove);
			if(categories[cIdx].codes.length <= 1) return showError(t('errLastCode'));
			if(confirm(t('confirmDelCode'))) {
				categories[cIdx].codes.splice(codeIdx, 1);
				saveData();
				renderConfig();
			}
		};

		window.askCreateSection = function() {
			playSound(sndMove);
			let name = prompt(t('promptNewSec'));
			if(!name) return;
			let lenStr = prompt(t('promptLen'));
			let len = parseInt(lenStr, 10);
			if(isNaN(len) || len <= 0) return showError(t('errLen'));

			let estimatedW = (len * 26) + 120;
			if(estimatedW > window.innerWidth * 0.9) return showError(t('errTooLong'));

			let code = prompt(t('promptCodeFirst', len));
			if(!code || code.length !== len || !/^\d+$/.test(code)) return showError(t('errDigitsLen', len));

			categories.push({
				name: name.trim(),
				isCollapsed: false,
				randomTarget: null,
				codes:[{ target: code.trim(), hint: findSolution(code.trim()), isActive: true }]
			});
			saveData();
			renderConfig();
		};

		window.askAddCode = function(cIdx) {
			playSound(sndMove);
			let reqLen = categories[cIdx].codes[0].target.length;
			let newCode = prompt(t('promptCodeNew', reqLen));
			if(!newCode) return;
			if(newCode.length !== reqLen || !/^\d+$/.test(newCode)) return showError(t('errDigitsLen', reqLen));

			categories[cIdx].codes.push({ target: newCode, hint: findSolution(newCode), isActive: true });
			saveData();
			renderConfig();
		};

		// ==========================================
		//		 GAME LOGIC
		// ==========================================

		function initConfig() {
			state = 'CONFIG';
			elConfigPanel.classList.remove('hidden');
			elGamePanel.classList.add('hidden');
			renderConfig();
		}

		window.startTraining = function() {
			playSound(sndConfirm); 
			blindMode = qHeld;
			state = 'WAITING_Z';
			currentCategoryIdx = 0;
			showHint = false;
			totalStartTime = Date.now();

			elConfigPanel.classList.add('hidden');
			elGamePanel.classList.remove('hidden');
			elMessage.innerText = "";
			setupCategory();
		};

		function setupCategory() {
			if (currentCategoryIdx >= categories.length) {
				state = 'FINISHED';
				elZPrompt.classList.add('hidden');
				const totalTime = Date.now() - totalStartTime;
				elCategory.innerText = t('allComplete');
				elMessage.innerText = t('completeMsg', totalTime);
				elDigits.innerHTML = "";
				elHint.classList.add('hidden');
				return;
			}

			state = 'WAITING_Z';
			enteredCodes =[];
			const category = categories[currentCategoryIdx];

			const reqLen = category.codes[0].target.length;
			const requiredWidth = Math.max(400, (reqLen * 26) + 120);
			elLockBox.style.width = requiredWidth + 'px';

			if (gameMode === 'RANDOM') {
				const activeCodes = category.codes.filter(c => c.isActive);
				const randIdx = Math.floor(Math.random() * activeCodes.length);
				category.randomTarget = activeCodes[randIdx].target;
			}

			elZPrompt.classList.remove('hidden');
			elCategory.innerText = `${t('cat')}: ${category.name}`;
			elHint.classList.add('hidden');
			showHint = false;

			resetDigits();
		}

		function resetDigits() {
			const reqLen = categories[currentCategoryIdx].codes[0].target.length;
			digits = Array(reqLen).fill(0);
			cursorPos = 0;
		}

		function startInput() {
			state = 'INPUTTING';
			elZPrompt.classList.add('hidden');
			startTime = Date.now();
			render();
		}

		function render() {
			if (state === 'FINISHED' || state === 'WAITING_Z' || state === 'CONFIG') return;

			elDigits.innerHTML = "";
			for (let i = 0; i < digits.length; i++) {
				const block = document.createElement('div');
				block.className = 'digit-block';

				const cursor = document.createElement('div');
				cursor.className = 'cursor';
				if (i !== cursorPos) cursor.classList.add('hidden-cursor');
				cursor.innerText = 'â–¸';

				const digit = document.createElement('div');
				digit.className = 'digit';
				digit.innerText = blindMode ? " " : digits[i];

				block.appendChild(cursor);
				block.appendChild(digit);
				elDigits.appendChild(block);
			}

			if (showHint) {
				const category = categories[currentCategoryIdx];
				const activeCodes = category.codes.filter(c => c.isActive);
				const unenteredCodes = activeCodes.filter(c => !enteredCodes.includes(c.target));

				if (unenteredCodes.length > 0) {
					unenteredCodes.sort((a, b) => (a.hint || "").length - (b.hint || "").length);
					elHint.innerText = unenteredCodes[0].hint || "";
				} else {
					elHint.innerText = "";
				}
				elHint.classList.remove('hidden');
			} else {
				elHint.classList.add('hidden');
			}
		}

		function checkConfirm() {
			const currentInput = digits.join('');
			const category = categories[currentCategoryIdx];
			const activeCodes = category.codes.filter(c => c.isActive);
			const matchedCode = activeCodes.find(c => c.target === currentInput);

			playSound(sndConfirm);

			if (matchedCode && !enteredCodes.includes(currentInput)) {
				enteredCodes.push(currentInput);
				showHint = false;

				if (gameMode === 'RANDOM') {
					if (currentInput === category.randomTarget) {
						const timeTaken = Date.now() - startTime;
						elMessage.innerText = `${t('good')} ${timeTaken} ${t('ms')}`;
						currentCategoryIdx++;
						setupCategory();
					} else {
						elMessage.innerText = t('goodBut');
						resetDigits();
						render();
					}
				} else {
					if (enteredCodes.length < activeCodes.length) {
						elMessage.innerText = t('next');
						resetDigits();
						render();
					} else {
						const timeTaken = Date.now() - startTime;
						elMessage.innerText = `${t('good')} ${timeTaken} ${t('ms')}`;
						currentCategoryIdx++;
						setupCategory();
					}
				}
			} else {
				elMessage.innerText = t('wrong');
				resetDigits();
				render();
			}
		}

		window.addEventListener('keydown', (e) => {
			const { code } = e;
			const isConfirm = ["KeyZ", "KeyC", "Enter", "NumpadEnter"].includes(code);
			const isHint = code === "KeyH";
			const isQ = code === "KeyQ";

			if (isQ) qHeld = true;
			if (e.repeat) return;

			if (state === 'WAITING_Z' && isConfirm) {
				playSound(sndConfirm);
				startInput();
				return;
			}

			if (state === 'INPUTTING') {
				const move = { ArrowLeft: -1, ArrowRight: 1 }[e.key];
				const change = { ArrowUp: 1, ArrowDown: -1 }[e.key];

				if (move !== undefined) {
					e.preventDefault();
					cursorPos = (cursorPos + move + digits.length) % digits.length;
					playSound(sndMove);
				} else if (change !== undefined) {
					e.preventDefault();
					digits[cursorPos] = (digits[cursorPos] + change + 10) % 10;
					playSound(sndMove);
				} else if (isConfirm) {
					e.preventDefault();
					checkConfirm();
				} else if (isHint) {
					e.preventDefault();
					showHint = !showHint;
				}
				render();
			}
		});

		window.addEventListener('keyup', (e) => {
			if (e.code === 'KeyQ') qHeld = false;
		});

		btnRestart.addEventListener('click', () => {
			playSound(sndRestart); 
			initConfig();
		});

		initApp();
	</script>
</body>
</html>